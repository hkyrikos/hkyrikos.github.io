$(function () {
    var f = "";
    var a = "";
    var e = $(window.opener.document);
    var c = 0;
    var b = "";
    var b8 = "";
    var d = [];
    jQuery.each(window.opener.watchlist, function () {
        f = $("#" + this, e).attr("data-materialnr");
        a = $("#" + this, e).find(".item").html();
        d.push(f + "|" + a.split("|")[0].replace("&nbsp;", "").replace("&nbsp;", "") + "|" + window.opener.watchlist_count[c]);
        b = "";
        b += '<div class="watchlist_item">';
        b += '  <div class="header">';
        b += '    <div class="id">' + this + "</div>";
        b += '    <div class="materialnr">' + f + "</div>";
        b += '    <div class="name">' + a + "</div>";
        b += "  </div>";
        b += '  <img src="data/img_' + window.opener.catalog_id + "/" + f + '_ai.jpg" /><br>';
        b += '  <input class="count" type="text" value="' + window.opener.watchlist_count[c] + '" />';
        b8 = b;
        b8 += "</div>";
        if ((c + 1) % 6 == 0 && (c + 1) != window.opener.watchlist.length) {
            b8 += '<div class="break"></div>'
        }
        $("#watchlist_print_8").append(b8);
        b += '  <div class="removefromwatchlist">Remove</div>';
        b += "</div>";
        $("#watchlist").append(b);
        b = "";
        b += '<div class="name">' + a + "/ " + f + "</div>";
        b += '<div class="count" id="count_' + this + '">' + window.opener.watchlist_count[c] + "</div>";
        b += '<img src="data/img_' + window.opener.catalog_id + "/" + f + '.jpg" />';
        if ((c + 1) % 2 == 0 && (c + 1) != window.opener.watchlist.length) {
            b += '<div class="break"></div>'
        }
        $("#watchlist_print").append(b);
        c++
    });
    $(".watchlist_item img").click(function () {
        var g = $(this).parent().find(".id").html();
        window.opener.loadImage($(e).find("#tree").find("#" + g))
    });
    $(".removefromwatchlist").click(function () {
        var i = $(this).parent().find(".id").html();
        var g = window.opener.watchlist.indexOf(i);
        if (g != -1) { window.opener.watchlist.splice(g, 1); }
        if (g != -1) { window.opener.watchlist_count.splice(g, 1); }
        var h = window.opener.watchlist.length == 1 ? "Item" : "Items";
        //$(e).find("#item_addtowatchlist").html("Add to Watchlist<br/>(" + window.opener.watchlist.length + " " + h + ")");

        $(e).find("#wlItems").html("(" + window.opener.watchlist.length + " " + h + ")");

        if (window.opener.watchlist.indexOf(window.opener.idAfterClick) == -1)
            $(e).find("#wlCounter").html("0");

        //$(e).find("#addtowatchlist").html("Add to Watchlist<br/>(" + window.opener.watchlist.length + " " + h + ")");
        $(this).parent().remove();
        watchlist_updated();
    });
    $(".count").keyup(function () {
        var h = $(this).val();
        if (h == "" || !IsNumeric(h)) {
            h = "1"
        }
        var i = $(this).parent().find(".id").html();
        var g = window.opener.watchlist.indexOf(i);
        if (g != -1) {
            window.opener.watchlist_count[g] = h
        }
        $("#count_" + i, "#watchlist_print").html(h);
        $(this).val(h);
        $(e).find("#wlCounter").html(h);
        watchlist_updated() 
    });

    $("#printwatchlist").click(function () {
        $("#watchlist_root").hide();
        $("#watchlist_print").show();
        window.print();
        setTimeout(resetWatchList, 1000);
    });
    $("#printwatchlist8").click(function () {
        $("#watchlist_root").hide();
        $("#watchlist_print_8").show();
        window.print();
        setTimeout(resetWatchList, 1000);
    });
    customer_watchlist_opened(d)
});
function resetWatchList()
{
    $("#watchlist_root").show();
    $("#watchlist_print").hide();
    $("#watchlist_print_8").hide();
}
function IsNumeric(a) {
    return (a - 0) == a && a.length > 0
}
function watchlist_updated() {
    var a = 0;
    var c = $(window.opener.document);
    var b = [];
    jQuery.each(window.opener.watchlist, function () {
        materialnr = $("#" + this, c).attr("data-materialnr");
        name = $("#" + this, c).find(".item").html();
        b.push(materialnr + "|" + name.split("|")[0].replace("&nbsp;", "").replace("&nbsp;", "") + "|" + window.opener.watchlist_count[a]); a++
    });
    customer_watchlist_updated(b)
};
