
var artSet;
var sortCol;
var clAmounts = new WatchlistSet();
var myCatalogs;
var catalogs;


function refreshCodeList() {

    var i = 0;
    artSet = new ArticleSet();
    sortCol = "AN_A";

    while ($("#catCB" + i).attr("Name") != undefined) {
        if ($("#catCB" + i).attr("checked") == true) {
            var catName = $("#catCB" + i).attr("name");
            jQuery.ajax({
                type: "GET",
                dataType: ($.browser.msie) ? "text" : "xml",
                url: "./data/" + catName + "_" + window.opener.language + ".xml",

                success: function (data, status) {
                    var cn;
                    var agt = navigator.userAgent.toLowerCase();
                    if (agt.indexOf("msie") != -1) {
                        cn = catName;
                    }
                    else {
                        cn = data.baseURI;
                        cn = cn.substring(cn.lastIndexOf('/') + 1);
                        cn = cn.substring(0, cn.lastIndexOf('_'));
                    }
                    if (typeof data == "string") {
                        catalogs = new ActiveXObject("Microsoft.XMLDOM");
                        catalogs.async = false;
                        catalogs.loadXML(data);
                    } else {
                        catalogs = data;
                    }


                    machineName = myCatalogs.getCatalogName(cn);

                    $(catalogs).find("stk").each(function () {

                        art = new Article(cn,
                                          $(this).attr("name"),
                                          $(this).attr("materialnr"),
                                          new Machine(cn, machineName, $(this).attr("Quantity")),
                                          $(this).attr("ET"),
                                          $(this).attr("Unit"));
                        artSet.AddArticle(art);
                    });

                }
            });
        }
        i = i + 1;
    }

    artSet.articles.sort(sortCodelist);

    window.setTimeout("drawTab()", 150); 
    //drawTab();
}

function drawTab() {
    var tab = "<table cellspacing=\"1\" cellpadding=\"0\" >";
    tab += "<tr><th align=\"left\" class=\"clHeadRow\">&nbsp;</th>" + 
            "   <th align=\"left\" class=\"clHeadRow\" id=\"thArtNr\">Article No</th>" +
            "   <th align=\"left\" class=\"clHeadRow\" id=\"thAss\" >Assembly</th>" +
            "   <th align=\"left\" class=\"clHeadRow\" id=\"thMach\">Machines</th>" +
            "   <th align=\"right\" class=\"clHeadRow\" id=\"thQuan\">Quantity</th>" +
            "   <th align=\"left\" class=\"clHeadRow\" id=\"thUnit\">Unit</th>" + 
            "   <th align=\"right\" class=\"clHeadRow\" id=\"thSPC\">SP-Code</th>" +
            "   <th align=\"center\" class=\"clHeadRow\">Amount</th>" + 
            "</tr>";

    var arts = artSet.getArticles();
    var len = artSet.getLength();
    var bgClass;
    for (i = 0; i < len; i++) {
        if (i % 2 == 0)
            bgClass = "clEvenRow";
        else
            bgClass = "clOddRow";

        var art = arts[i];
        for (k = 0; k < art.machines.length; k++) {

            if (k == 0) {
                tab += "<tr>";
                tab += "<td align=\"center\" class=\"" + bgClass + "\" rowspan=\"" + art.machines.length + "\" ><img src=\"images/imgInfo.png\" id=\"img" + art.articleNr + "\" name=\"" + art.name + "\" catid=\"" + art.catid + "\" /></td>";
                tab += "<td align=\"left\" class=\"" + bgClass + "\" rowspan=\"" + art.machines.length + "\">";
                tab += art.articleNr;
                tab += "</td><td align=\"left\" class=\"" + bgClass + "\" rowspan=\"" + art.machines.length + "\">";
                tab += art.name;
                tab += "</td><td align=\"left\" class=\"" + bgClass + "\">";
                tab += art.machines[k].name + " / " + art.machines[k].id;
                tab += "</td><td align=\"right\" class=\"" + bgClass + "\">";
                tab += art.machines[k].quantity;
                tab += "</td><td align=\"left\" class=\"" + bgClass + "\" rowspan=\"" + art.machines.length + "\">";
                tab += (art.unit == undefined ? "" : art.unit); 
                tab += "</td><td align=\"right\" class=\"" + bgClass + "\" rowspan=\"" + art.machines.length + "\">";
                tab += art.code;
                tab += "</td><td align=\"right\" class=\"" + bgClass + "\"  rowspan=\"" + art.machines.length + "\">";
                tab += "<table>" +
               "  <tr><td>&nbsp;&nbsp;&nbsp;</td><td>" +
               "      <input id='bCLAddWL_" + art.articleNr + "_" + art.code + "' type='button' value='+'/>" +
               "  </td><td class='clWLCounter'> " +
               "      <span id='clCounter_" + art.articleNr + "_" + art.code + "'>";
                tab += getWLCount(art.articleNr, art.code);
                tab += "      </span>" +
               "  </td><td> " +
               "      <input id='bCLRemWL_" + art.articleNr + "_" + art.code + "' type='button' value='-'/>" +
               "  </td></tr> " +
               "</table> ";
                tab += "</td></tr>";
            }
            else {
                tab += "<tr><td align=\"left\" class=\"" + bgClass + "\">";
                tab += art.machines[k].name + " / " + art.machines[k].id;
                tab += "<td align=\"right\" class=\"" + bgClass + "\">";
                tab += art.machines[k].quantity;
                tab += "</td></tr>";
            }
        }
    };
    tab += "</table>";
    $("#codelistContent").html(tab);

    for (i = 0; i < len; i++) {
        var art = arts[i];
        $("#bCLAddWL_" + art.articleNr + "_" + art.code).click(function () {
            var artNr = $(this).attr("id").substring(9, $(this).attr("id").lastIndexOf("_"));
            var artCode = $(this).attr("id").substring($(this).attr("id").lastIndexOf("_") + 1);
            if (!clAmounts.Contains(artNr, artCode)) {
                var newArt = artSet.getArticle(artNr, artCode);
                var wlI = new WatchlistItem(artNr, newArt.catid, newArt.name, artCode);
                clAmounts.Add(wlI);
            }
            else {
                clAmounts.getItem(artNr, artCode).count++;
            }
            for (var j = 0; j < artSet.getArticle(artNr, artCode).machines.length; j++) {
                clAmounts.getItem(artNr, artCode).AddMachine(artSet.getArticle(artNr, artCode).machines[j]);
            }
            $("#clCounter_" + artNr + "_" + artCode).html(getWLCount(artNr, artCode));
        });
        $("#bCLRemWL_" + art.articleNr + "_" + art.code).click(function () {
            var artNr = $(this).attr("id").substring(9, $(this).attr("id").lastIndexOf("_"));
            var artCode = $(this).attr("id").substring($(this).attr("id").lastIndexOf("_") + 1);
            if (clAmounts.Contains(artNr, artCode)) {
                if (clAmounts.getItem(artNr, artCode).count == 1) {
                    clAmounts.Remove(artNr, artCode);
                }
                else
                    clAmounts.getItem(artNr, artCode).count--;
                $("#clCounter_" + artNr + "_" + artCode).html(getWLCount(artNr, artCode));
            }

            //watchlist.PrintWL();
        });
        $("#img" + art.articleNr).mouseenter(function (event) {
            var artNr = $(this).attr("id").substring(3);
            $('#clParts .title').html("Article Number: " + artNr);
            $('#clParts #clName').html($(this).attr("name"));

            // set thumbnail picture
            $("#clThumbnail").css("visibility", "visible");
            $('#clThumbnail').attr("src", "data/img_" + $(this).attr("catid") + "/" + artNr + "_ai.jpg");
            
            // positionate and show the quickview
            var qvY = event.pageY - 25;
            if (qvY > $(window.document).height() - 215)
                qvY = $(window.document).height() - 215;
            
            $("#clQuickview").css("top", qvY);
            $("#clQuickview").css({
                'left': (event.pageX - $("#clLeft").css("width").replace("px", "")) + 'px'
            });

            $("#clQuickview").show();

        });
        $("#img" + art.articleNr).mouseleave(function () {
            $("#clQuickview").hide();
        });
    }

    $("#thArtNr").click(function () {
        if (sortCol == "AN_A") sortCol = "AN_D";
        else sortCol = "AN_A";
        artSet.articles.sort(sortCodelist);
        drawTab();
    });

    $("#thAss").click(function () {
        if (sortCol == "AS_A") sortCol = "AS_D";
        else sortCol = "AS_A";
        artSet.articles.sort(sortCodelist);
        drawTab();
    });

    $("#thMach").click(function () {
        if (sortCol == "MA_A") sortCol = "MA_D";
        else sortCol = "MA_A";
        artSet.articles.sort(sortCodelist);
        drawTab();
    });

    $("#thQuan").click(function () {
        if (sortCol == "QU_A") sortCol = "QU_D";
        else sortCol = "QU_A";
        artSet.articles.sort(sortCodelist);
        drawTab();
    });

    $("#thSPC").click(function () {
        if (sortCol == "CO_A") sortCol = "CO_D";
        else sortCol = "CO_A";
        artSet.articles.sort(sortCodelist);
        drawTab();
    });

    $("#bSendMail").unbind("click");
    $("#bSendMail").click(function () {
        var includedMachines = new Array();

        var body = "***%0A";
        for (var i = 0; i < clAmounts.getLength(); i++) {

            var artikel = clAmounts.getItems()[i];

            for (var j = 0; j < artikel.machines.length; j++) {

                var machine = artikel.machines[j];
                var fund = false;

                for (var k = 0; k < includedMachines.length; k++) {
                    if (machine.id == includedMachines[k]) {
                        fund = true;
                    }
                }
                if (fund == false) {
                    var catID = myCatalogs.getCatalogNumber(machine.name);
                    if (catID.length > 0) {
                        body += catID + " " + machine.name + "%0A";
                        includedMachines.push(machine.id);
                    }
                }
            }
        }
        body += "***%0A<SparepartList>%0A";
        for (var i = 0; i < clAmounts.getLength(); i++) {
            body += "<Assembly ArtNr='" + clAmounts.getItems()[i].materialNr + "' Code='" + clAmounts.getItems()[i].code + "' Value='" + clAmounts.getItems()[i].count + "'/>%0A";
        }
        body += "</SparepartList>";
        
        self.location = 'mailto:?subject=SparePart Catalog - Demand&body=[Insert your text here]%0A%0A%0ADo not change the following code!%0A' + body;
    });

    clResize();
}

function sortMachines(a, b) {
    return a.id.localeCompare(b.id);
}


function sortCodelist(a, b) {
    var comp1, comp2;
    var compString;

    if (sortCol.substring(0,2) == "AN") {
        comp1 = a.articleNr.toLowerCase();
        comp2 = b.articleNr.toLowerCase();
        compString = true;
    }
    else if (sortCol.substring(0,2) == "AS") {
        comp1 = a.name.toLowerCase();
        comp2 = b.name.toLowerCase();
        compString = true;
    }
    else if (sortCol.substring(0,2) == "MA") {
        comp1 = a.machines[0].toLowerCase();
        comp2 = b.machines[0].toLowerCase();
        compString = true;
    }
    else if (sortCol.substring(0,2) == "QU") {
        comp1 = a.quantity;
        comp2 = b.quantity;
        compString = false;
    }
    else {
        comp1 = a.code;
        comp2 = b.code;
        compString = false;
    }

    var ret;
    if (compString) ret = comp1.localeCompare(comp2);
    else ret = (comp1 < comp2 ? -1 : (comp1 > comp2 ? 1 : 0));

    if (sortCol.substring(3, 4) == 'D') ret = ret * -1;

    return ret;
}

function getWLCount(artNr, artCode) {
    if (clAmounts.Contains(artNr, artCode))
        return clAmounts.getItem(artNr, artCode).count;
    else
       return "0";
}

function clResize() {
    $("#clLeft").css("height", $(window.document).height() + "px");
    $("#clHandle").css("height", $(window.document).height() + "px");
    $("#clCatalogs").css("height", $("#clLeft").height() - 25 + "px");
    $("#codelistContent").css("width", $(window.document).width() - $("#clLeft").width() - 5 - 21 + "px");
    $("#codelistContent").css("height", $("#clLeft").height() - 75 + "px");  // $("#left").height() - 100 + "px");
}

function Initialize() {

    $('#clHandle').mousedown(function () {
        $(document).bind('mousemove', onMoveHandle);
        $(document).bind('mouseup', onLeaveHandle);
    });
    var onMoveHandle = function (event) {


        var x = event.pageX;

        if (x < 0 || x > $(window.document).width() - 10)
            return false;

        handleWidth = 2;
        $('#clLeft').css('width', x);
        $('#clHandle').css('left', x);
        $('#rightCodelist').css('left', x + 5);
        clResize();
        return false;
    }
    var onLeaveHandle = function () {
        $(document).unbind('mousemove', onMoveHandle);
        $(document).unbind('mouseup', onLeaveHandle);
        //$(document).enableTextSelect();
    }

    $("#clCatalogs").html("");

    var str = "";
    str += "<table><tr><td>";
    str += "<input type=\"button\" id=\"bCatCheckAll\" class=\"filterButton\" value=\"All\" />";
    str += "</td><td>";
    str += "<input type=\"button\" id=\"bCatCheckNone\" class=\"filterButton\" value=\"None\" />";
    str += "</td></tr></table>";
    $("#clCatalogs").append(str);

    $("#bCatCheckAll").click(function () {
        for (i = 0; $("#catCB" + i).attr("Name") != undefined; i++) {
            $("#catCB" + i).attr("checked", true);
        }
    });
    $("#bCatCheckNone").click(function () {
        for (i = 0; $("#catCB" + i).attr("Name") != undefined; i++) {
            $("#catCB" + i).attr("checked", false);
        }
    });

    var catalogs;
    myCatalogs = new CatalogeOnCD();
    jQuery.ajax({
        type: "GET",
        dataType: ($.browser.msie) ? "text" : "xml",
        url: "catalogs.xml",

        success: function (data, status) {
            if (typeof data == "string") {
                catalogs = new ActiveXObject("Microsoft.XMLDOM");
                catalogs.async = false;
                catalogs.loadXML(data);
            } else {
                catalogs = data;
            }

            i = 0;
            $(catalogs).find("catalog").each(function () {
                var description = $(this).attr("description") || "";
                var catName = $(this).text();
                var catID = $(this).attr("id");
                catName = catName.substring(0, catName.length - catID.length - 1);
                $("#clCatalogs").append("<div class=\"catalogCL\" title=\"" + description + "\" id=\"cat" + catID + "\"><table cellspacing=\"0\" cellpadding=\"0\"><tr><td width=\"17\"><input type=\"checkbox\" id=\"catCB" + i + "\" name=\"" + catID + "\" checked=\"true\" /></td><td>" + catName + " / " + catID + "</td></tr></table></div>");
                myCatalogs.Add(catID, catName);
                i = i + 1;
            });

            customer_catalogs_loaded();

        }
    });


    $("#bSearch").click(function () {
        refreshCodeList();
    });

    // Codelist form
    $("#bCLCheckAll").click(function () {
        $("#cbCL1").attr("checked", true);
        $("#cbCL2").attr("checked", true);
        $("#cbCL3").attr("checked", true);
        $("#cbCL4").attr("checked", true);
        $("#cbCL5").attr("checked", true);
        $("#cbCL6").attr("checked", true);
        $("#cbCL7").attr("checked", true);
        $("#cbCL8").attr("checked", true);
    });
    $("#cCLCheckNone").click(function () {
        $("#cbCL1").attr("checked", false);
        $("#cbCL2").attr("checked", false);
        $("#cbCL3").attr("checked", false);
        $("#cbCL4").attr("checked", false);
        $("#cbCL5").attr("checked", false);
        $("#cbCL6").attr("checked", false);
        $("#cbCL7").attr("checked", false);
        $("#cbCL8").attr("checked", false);
    });

}



// KLASSE ArticleSet

function ArticleSet() {
    this.articles = new Array();
}

ArticleSet.prototype.AddArticle = function (article) {
    if (!this.matchFilter(article))
        return;
    if ($("#cbShow").attr("checked") == true && getWLCount(article.articleNr, article.code) <= 0)
        return;

    var fund = false;
    for (j = 0; j < this.articles.length; j++) {
        var art = this.articles[j];
        if (art.articleNr == article.articleNr && art.code == article.code) {
            fund = true;
            var fundm = false;
            for (l = 0; l < art.machines.length; l++) {
                if (art.machines[l].IsEqual(article.machines[0])) {
                    art.machines[l].quantity = parseFloat(art.machines[l].quantity) + parseFloat(article.machines[0].quantity);
                    fundm = true;
                }
            }
            if (!fundm) {
                art.machines.push(article.machines[0]);
                art.machines.sort(sortMachines);
            }
        }
    }
    if (!fund)
        this.articles.push(article);
}

ArticleSet.prototype.getLength = function () {
    return this.articles.length;
}

ArticleSet.prototype.getArticles = function () {
    return this.articles;
}

ArticleSet.prototype.getArticle = function (artNr, code) {
    for (m = 0; m < this.articles.length; m++) {

        if (this.articles[m].articleNr == artNr && this.articles[m].code == code) {
            return this.articles[m];
        }
        
    }
    return undefined;
}

ArticleSet.prototype.matchFilter = function (article) {
    if ((article.code == 1 && $("#cbCL1").attr("checked") == true) ||
        (article.code == 2 && $("#cbCL2").attr("checked") == true) ||
        (article.code == 3 && $("#cbCL3").attr("checked") == true) ||
        (article.code == 4 && $("#cbCL4").attr("checked") == true) ||
        (article.code == 5 && $("#cbCL5").attr("checked") == true) ||
        (article.code == 6 && $("#cbCL6").attr("checked") == true) ||
        (article.code == 7 && $("#cbCL7").attr("checked") == true) || 
        (article.code == 8 && $("#cbCL8").attr("checked") == true))
        return true;
    else 
        return false;
}

// KLASSE ArticleSet ENDE

// KLASSE Article

function Article(catid, name, articleNr, machine, code, unit) {
    this.catid = catid;
    this.name = name;
    this.articleNr = articleNr;
    this.machines = new Array();
    this.machines.push(machine);
    this.code = code;
    this.unit = unit;
}

// KLASSE Article ENDE

// KLASSE Maschine

function Machine(id, name, quantity) {
    this.id = id;
    this.name = name;
    this.quantity = quantity;
}

Machine.prototype.IsEqual = function(machine){
    return this.name == machine.name && this.id == machine.id;
}

// KLASSE Maschine ENDE

// KLASSE Cataloge 

function CatalogeOnCD(){
    this.catOnCDID = new Array();
    this.catOnCDName = new Array();
}

CatalogeOnCD.prototype.Add = function (catID, catName) {
    this.catOnCDID.push(catID);
    this.catOnCDName.push(catName);
}
    
CatalogeOnCD.prototype.getCatalogNumber = function(searchName) {
    for (var i = 0; i < this.catOnCDName.length; i++) {
        if (this.catOnCDName[i] == searchName) {
            return this.catOnCDID[i];
        }
    }
}

CatalogeOnCD.prototype.getCatalogName = function(searchNumber) {
    for (var i = 0; i < this.catOnCDID.length; i++) {
        if (this.catOnCDID[i] == searchNumber) {
            return this.catOnCDName[i];
        }
    }
}
