$(function () {
    var f = "";
    var a = "";
    var e = $(window.opener.document);
    var c = 0;
    var b = "";
    var b8 = "";
    var d = [];
    var wlItems = window.opener.watchlist.getItems();
    for (i = 0; i < wlItems.length; i++) {
        var wlItem = wlItems[i];
        f = wlItem.materialNr; //$("#" + this, e).attr("data-materialnr");
        a = wlItem.name; //$("#" + this, e).find(".item").html();

        d.push(f + "|" + a.split("|")[0].replace("&nbsp;", "").replace("&nbsp;", "") + "|" + wlItem.count);
        b = "";
        b += '<div class="watchlist_item">';
        b += '  <div class="header">';
        b += '    <div class="id">' + f + "</div>";
        b += '    <div class="materialnr">' + f + "</div>";
        b += '    <div class="name">' + a + "</div>";
        b += "  </div>";
        b += '  <img src="data/img_' + wlItem.catalogId + "/" + f + '_ai.jpg" /><br>';
        b += '  <input class="count" type="text" value="' + wlItem.count + '" />';
        b8 = b;
        b8 += "</div>";

        if ((c + 1) % 6 == 0 && (c + 1) != wlItems.length) {
            b8 += '<div class="break"></div>'
        }
        $("#watchlist_print_8").append(b8);
        b += '  <div class="removefromwatchlist">Remove</div>';
        b += "</div>";
        $("#watchlist").append(b);
        b = "";
        b += '<div class="name">' + a + "/ " + f + "</div>";
        b += '<div class="count" id="count_' + this + '">' + wlItem.count + "</div>";
        b += '<img src="data/img_' + wlItem.catalogId + "/" + f + '.jpg" />';
        if ((c + 1) % 2 == 0 && (c + 1) != wlItems.length) {
            b += '<div class="break"></div>'
        }
        $("#watchlist_print").append(b);
        c++;
    }

    $(".watchlist_item img").click(function () {
        if (window.opener.codelistView)
            return;

        var g = $(this).parent().find(".id").html();
        var fund = false;

        $(e).find("#tree").find("li").each(function () {
            if ($(this).attr("data-materialnr") == g && fund == false) {
                window.opener.loadImage(this);
                fund = true;
            }
        });
        if (!fund)
            alert('Assembly not found in opened catalog.');
    });
    $(".removefromwatchlist").click(function () {
        var i = $(this).parent().find(".id").html();
        var wl = window.opener.watchlist;
        wl.Remove(i);

        if (!window.opener.codelistView) {
            var h = wl.getLength() == 1 ? "Item" : "Items";
            $(e).find("#wlItems").html("(" + wl.getLength() + " " + h + ")");

            if (!wl.Contains(window.opener.idAfterClick))
                $(e).find("#wlCounter").html("0");
        }
        else {
            $(e).find("#clCounter_" + i).html("0");
        }

        $(this).parent().remove();
        watchlist_updated();
    });
    $(".count").keyup(function () {
        var h = $(this).val();
        if (h == "" || !IsNumeric(h)) {
            h = "1"
        }
        var i = $(this).parent().find(".id").html();
        var wl = window.opener.watchlist;
        if (wl.Contains(i)) {
            wl.getItem(i).count = h
        }

        if (!window.opener.codelistView)
            $("#count_" + i, "#watchlist_print").html(h);
        else
            $(e).find("#clCounter_" + i).html(h);

        $(this).val(h);

        $(e).find("#wlCounter").html(h);
        watchlist_updated();
    });

    $("#printwatchlist").click(function () {
        $("#watchlist_root").hide();
        $("#watchlist_print").show();
        window.print();
        setTimeout(resetWatchList, 1000);
    });
    $("#printwatchlist8").click(function () {
        $("#watchlist_root").hide();
        $("#watchlist_print_8").show();
        window.print();
        setTimeout(resetWatchList, 1000);
    });
    $("#clearwatchlist").click(function () {
        wl = window.opener.watchlist;
        while (wl.getLength() > 0) {
            wl.Remove(wl.getItems()[0].materialNr);
        }
        var h = wl.getLength() == 1 ? "Item" : "Items";

        if (!window.opener.codelistView) {
            $(e).find("#wlItems").html("(" + wl.getLength() + " " + h + ")");
            if (!wl.Contains(window.opener.idAfterClick))
                $(e).find("#wlCounter").html("0");
        }
        else {
            $(e).find("span").each(function () {
                var fid = $(this).attr("id");
                if (fid.substring(0, 10) == "clCounter_" && $(this).html() != "0") {
                    $(this).html("0");
                }
            });
        }

        $("#watchlist").find("div").each(function () {
            if ($(this).attr("class") == "watchlist_item") {
                $(this).remove();
            }
        });

        watchlist_updated();
    });
    customer_watchlist_opened(d);
});
function resetWatchList()
{
    $("#watchlist_root").show();
    $("#watchlist_print").hide();
    $("#watchlist_print_8").hide();
}
function IsNumeric(a) {
    return (a - 0) == a && a.length > 0
}
function watchlist_updated() {
    var a = 0;
    var c = $(window.opener.document);
    var b = [];
    jQuery.each(window.opener.watchlist, function () {
        materialnr = $("#" + this, c).attr("data-materialnr");
        name = $("#" + this, c).find(".item").html();
        b.push(materialnr + "|" + name.split("|")[0].replace("&nbsp;", "").replace("&nbsp;", "") + "|" + window.opener.watchlist_count[a]);
        a++;
    });
    customer_watchlist_updated(b)
}
